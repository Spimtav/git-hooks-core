#!/usr/bin/env bash

if ! command -v "cred-alert-cli" >/dev/null 2>&1; then
  exit
fi

if [ -e .git/ORIG_HEAD ] ; then
  ORIG_HEAD=.git/ORIG_HEAD
elif [ -f .git ] ; then
  # In a submodule
  ORIG_HEAD=$(sed 's/^gitdir: *//' .git)/ORIG_HEAD
  if [ ! -e "${ORIG_HEAD}" ] ; then
      echo "$PWD/.git ==> $(cat .git) doesn't point to an ORIG_HEAD file"
      exit 0
  fi
else
  echo "$PWD/.git/ORIG_HEAD not found, can't check for possible credentials in the merge"
  exit 0
fi

output=$( git diff $( cat "${ORIG_HEAD}" )..HEAD | cred-alert-cli scan --diff --show-suspected-credentials)
status="$?"
if [ "${status}" -eq 3 ]; then
  printf "\n"
  printf "Found possible credentials in the merge! Locations are listed below:\n"
  printf "\n"
  printf "%s" "$output"
  printf "\n"
fi
exit "${status}"
